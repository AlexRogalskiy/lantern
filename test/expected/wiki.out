CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION
CREATE EXTENSION IF NOT EXISTS lanterndb;
CREATE EXTENSION

SET statement_timeout = 0;
SET
SET lock_timeout = 0;
SET
SET idle_in_transaction_session_timeout = 0;
SET
SET client_encoding = 'UTF8';
SET
SET standard_conforming_strings = on;
SET
SELECT pg_catalog.set_config('search_path', 'public', false);
 set_config 
------------
 public
(1 row)

SET check_function_bodies = false;
SET
SET xmloption = content;
SET
SET client_min_messages = warning;
SET
SET row_security = off;
SET
SET default_tablespace = '';
SET
SET default_table_access_method = heap;
SET
CREATE TABLE tsv_data (
    language text,
    page_url text,
    image_url text,
    page_title text,
    section_title text,
    hierarchical_section_title text,
    caption_reference_description text,
    caption_attribution_description text,
    caption_alt_text_description text,
    mime_type text,
    original_height integer,
    original_width integer,
    is_main_image boolean,
    attribution_passes_lang_id boolean,
    page_changed_recently boolean,
    context_page_description text,
    context_section_description text,
    id integer NOT NULL,
    context_page_description_ai vector(512),
    image_ai vector(512)
);
CREATE TABLE
CREATE SEQUENCE tsv_data_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;
CREATE SEQUENCE
ALTER TABLE ONLY tsv_data ALTER COLUMN id SET DEFAULT nextval('tsv_data_id_seq'::regclass);
ALTER TABLE
ALTER TABLE ONLY tsv_data
    ADD CONSTRAINT tsv_data_pkey PRIMARY KEY (id);
ALTER TABLE
COPY  tsv_data FROM STDIN DELIMITER E'\t';
COPY 100
select id, page_title,  context_page_description_ai <-> (select context_page_description_ai from tsv_data where id = 81386) as dist
 from tsv_data order by dist
 limit 10;
  id   |              page_title              |        dist        
-------+--------------------------------------+--------------------
 81386 | Madge Elliott                        |                  0
 81735 | Frank Hall Crane                     |  5.530589137876187
 95321 | Miriam Van Waters                    |  6.487261860557181
 81583 | Emile P. Moses                       |  6.556191837965934
 81417 | Victor Iamandi                       |  6.917446804350846
 81601 | Graciela                             |  6.959552382510196
 81377 | Robert Christie (Ontario politician) |   7.04102269273351
 81375 | Ralph Dacre, 3rd Baron Dacre         |  7.121137347316711
 95386 | Alexandre Étienne Choron             |   7.13683763115891
 81846 | Frank Carlucci                       | 7.2480450046710105
(10 rows)

CREATE INDEX ON tsv_data USING embedding (context_page_description_ai vector_l2_ops);
psql:test/sql/wiki.sql:65: INFO:  usearch_init_options_t: metric_kind: 1, metric: 0x0, quantization: 0, dimensions: 512, connectivity: 16, expansion_add: 128, expansion_search: 64
psql:test/sql/wiki.sql:65: INFO:  done init usearch index
psql:test/sql/wiki.sql:65: INFO:  inserted 100 elements
psql:test/sql/wiki.sql:65: INFO:  done saving 100 vectors
CREATE INDEX
CREATE INDEX ON tsv_data USING embedding (context_page_description_ai) with (ef = 100, ef_construction=150 , M=11, alg="hnswlib");
psql:test/sql/wiki.sql:66: INFO:  usearch_init_options_t: metric_kind: 1, metric: 0x0, quantization: 0, dimensions: 512, connectivity: 11, expansion_add: 150, expansion_search: 100
psql:test/sql/wiki.sql:66: INFO:  done init usearch index
psql:test/sql/wiki.sql:66: INFO:  inserted 100 elements
psql:test/sql/wiki.sql:66: INFO:  done saving 100 vectors
CREATE INDEX
set enable_seqscan=false;
SET
select id, page_title, context_page_description_ai <-> (select context_page_description_ai from tsv_data where id = 81386) as dist
 from tsv_data order by dist limit 10;
psql:test/sql/wiki.sql:69: INFO:  cost estimate
psql:test/sql/wiki.sql:69: INFO:  returning small cost to always use the index
psql:test/sql/wiki.sql:69: INFO:  cost estimate
psql:test/sql/wiki.sql:69: INFO:  returning small cost to always use the index
psql:test/sql/wiki.sql:69: INFO:  began scanning with 0 keys and 1 orderbys
psql:test/sql/wiki.sql:69: INFO:  starting scan with dimensions=512 M=11 efConstruction=150 ef=100
psql:test/sql/wiki.sql:69: INFO:  usearch index initialized
  id   |              page_title              |        dist        
-------+--------------------------------------+--------------------
 81386 | Madge Elliott                        |                  0
 81735 | Frank Hall Crane                     |  5.530589137876187
 95321 | Miriam Van Waters                    |  6.487261860557181
 81583 | Emile P. Moses                       |  6.556191837965934
 81417 | Victor Iamandi                       |  6.917446804350846
 81601 | Graciela                             |  6.959552382510196
 81377 | Robert Christie (Ontario politician) |   7.04102269273351
 81375 | Ralph Dacre, 3rd Baron Dacre         |  7.121137347316711
 95386 | Alexandre Étienne Choron             |   7.13683763115891
 81846 | Frank Carlucci                       | 7.2480450046710105
(10 rows)

select id, page_title, context_page_description_ai <-> (select context_page_description_ai from tsv_data where id = 81518) as dist
 from tsv_data order by dist limit 3;
psql:test/sql/wiki.sql:71: INFO:  cost estimate
psql:test/sql/wiki.sql:71: INFO:  returning small cost to always use the index
psql:test/sql/wiki.sql:71: INFO:  cost estimate
psql:test/sql/wiki.sql:71: INFO:  returning small cost to always use the index
psql:test/sql/wiki.sql:71: INFO:  began scanning with 0 keys and 1 orderbys
psql:test/sql/wiki.sql:71: INFO:  starting scan with dimensions=512 M=11 efConstruction=150 ef=100
psql:test/sql/wiki.sql:71: INFO:  usearch index initialized
  id   |          page_title          |       dist        
-------+------------------------------+-------------------
 81518 | Battle of Tannach            |                 0
 81864 | Battle of Trincomalee        | 6.277988148236901
 81375 | Ralph Dacre, 3rd Baron Dacre | 6.283957082106894
(3 rows)

